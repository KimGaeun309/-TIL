# 11강 - Text LCD

TEXT LCD 라고 하는 CPU 밖에 있는 LCD를 출력하는 컨트롤러 (= 외부장치) 를 제어해해보자.

## TEXT LCD(Character LCD)

우리가 지금까지 프로세서가 있으면 프로세서 안에 코어가 있고 별도로 컨트롤러 - interrupt timer serial gpio  - 로 제어하는 방법을 알아보았다. 이런 내부의 맵에 레지스터로 맵핑 되어있는 컨트롤러들을 제어해보았다.

이번 시간에는 CPU 프로세서 바깥에 장치가 있어서 그 장치를 외부 핀과 연결해서 제어하는 실습을 해볼 것이다. 우리가 사용할 장치는 LCD이다. 

## HBE-MCU-Multi Text LCD

LCD는 전기적인 신호의 반사를 이용해 영상 등을 디스플레이할 수 있는 장치인데 우리는 이번에 간단한 두 줄짜리 Text LCD 를 사용해볼 것이다.

## 인터페이스 커넥터 핀 기능

기본적으로 프로세서에서 LCD를 제어하는데 LCD 자체가 하나의 컨트롤러 역할을 할 수 있다. 독립적으로 이 디바이스를 구동시키고 프로세서가 이를 제어한다. 이것 또한 하드웨어이므로 구조를 보자면 총 16개 핀이 있다. VSS, VDD는 전원 핀. (하나는 5v, 하나는 0v) VEE는 전압레벨 핀. 이렇게 세 개는 pin을 연결해서 하드웨어에 전원을 공급한다. 

그리고 나머지 핀 중 RS, R/W, E 세 개 컨트롤 신호(제어 신호), 그리고 DB0~DB7 8개 Data 신호 이 총 11개 신호는 실제 마이크로프로세서와 연결된다.

 A, K 두 개는 밝기 조절을 한다. 

## Text LCD(Character LCD) 구조

+) 뒤에 그림과 표 보면서 설명함

그림을 보면 기본적으로 마이크로프로세서의 구조에서 프로세서가 어떤 외부 디바이스, 장치, 메모리 등을 제어하기 위해서는 연결되는 신호에 세 가지 타입이 있다. Control, Data, Enable 이렇게. (Enable은 Control신호에 포함되었다고 생각) 그래서 일반적으로 Control 신호, Data 신호를 가지고 제어를 할 수 있는데 어떻게 제어하는지 파악을 해야 하는데 이건 디바이스마다 다르다. Text LCD 디바이스가 어떻게 동작하는지를 우리는 이해하고 이 프로세서에서 이 디바이스를 제어하기 위해 어떤 컨트롤 신호와 데이터 신호를 주어야 하는지 구현해서 신호를 내보내어 외부 장치를 제어할 수 있다. Text 는 ASCII 코드값을 'A' ~ 'Z', 'a' ~ 'z' 를 각각 문자로 출력하는 제어... 그를 위해 LCD구조를 먼저 파악해야 한다.

LCD 창이 있으면 LCD Display가 있고 내부적으로 이 Display를 제어하는 어떤 영역 = 제어부가 있다. 제어하기 위해서 제어부에는 크게 두 가지 영역이 있는데 명령어 영역와 Data 영역이 있다. 명령어에는 어떤 위치에 문자를 쓰라 등의 명령어가 있다. 이 명령어를 프로세서에서 컨트롤 신호와 데이터 신호로 내보내 명령어를 쓰고 출력할 데이터를 Data 레지스터로 쓴다. 이 명령어 레지스터 IR과 Data 레지스터 DR 이렇게 두 가지 레지스터를 제어할 수 있으면 된다.

어떤 걸 제어할 수 있냐면, 디스플레이를 깨끗이 지워라. 두 개의 줄이고 문자를 한 줄당 40개씩 출력할 수 있는데 이를 지우고 싶으면 Clear Display라는 명령어를 내보낸다. 그리고 Return Home 으로 첫번째 줄 제일 왼쪽 자리로 위치를 이동시키라는 명령어, .... 등으로 구성되어있다. 

명령어들을 Clear Display, Return Home 등의 명령에 대한 명령어 코드 값이 테이블에 정해져있다. 명령어에 대한 명령어 값이라고 얘기할 수 있다. 이런 명령어들을 프로세서에서 IR 레지스터에 쓰면 명령어가 실행된다. 특정 명령어들을 설정해주기 위해서는 이런 값들을 명령해줄 필요가 있다. 또 하나는 디스플레이에 출력하는 것이 목적이므로 Data write to CG RAM or DD RAM 이라는 명령어로 각각의 정해진 메모리 위치에 데이터를 갖다놓을 수 있다. 이 명령어를 쓰면 이 주소에 데이터를 보낸다. 그러면 그 위치에 데이터를 보내 출력시킨다.

- 명령레지스터(IR)
- 데이터레지스터(DR)
- RS, R/W  신호에 따른 TEXT LCD 제어기 레지스터 선택방법

텍스트 LCD 안에는 명령어 레지스터 IR과 데이터 레지스터 DR이 있는데 제어를 해서 어떤 경우엔 IR에, 어떤 경우엔 DR에 값을 써주거나 읽을 수 있다. 그러면 네 가지 경우가 있다. IR 레지스터에 값을 쓰는 경우, IR 레지스터의 값을 읽는 경우, DR 레지스터에 값을 쓰는 경우, DR 레지스터의 값을 읽는 경우. 앞에서 봤듯 컨트롤 신호에느 RS, R/W 두 개의 비트를 가지고 이 네 가지 경우를 구분한다. RS가 0일 경우엔 IR과 관련되고, RS가 1일 경우엔 DR과 관련된다. R/W가 0이면 쓰는 경우이고, R/W가 1이면 읽는 경우이다.  

IR을 읽는 경우에 BF 읽기, AC 읽기 두 가지가 있는데 BF는 Busy Flag이고 AC는 Address Counter 로, BF는 현재 디바이스가 바쁜 상태인지 (명령어를 내릴 수 있는 상태인지 아닌지) 확인한다.

DR에 쓰는 경우 DR레지스터에 'A'를 쓰면 특정 위치에 'A'가 출력된다.

정리하자면 LCD 안에 IR, DR 두 가지 레지스터가 있고 IR에 값을 쓰면 LCD 제어기를 제어하는 명령어를 쓰는 것이고 DR은 출력할 데이터를 쓰는 용도이다. IR에 쓸지 DR에 쓸지 혹은 IR의 값을 읽을지 DR의 값을 읽을지... 를 정하는 것은 RS, R/W 라고 하는 마이크로프로세서의 신호이다. 

- BF (Busy Flag) - 특정 명령어에서 Busy Flag를 체크하는데 RS가 0이고 R/W가 1이면 BF의 값을 읽는다. DB7 값이 BF. BF가 1이면 LCD가 바쁜 상태이고 0이면 다음 명령 수행 가능하다.
- AC (Address Counter) - DDRAM (CGRAM은 사용X. 몰라도됨) 첫 번째 줄에 40개 두 번째 줄에 40개 문자. 첫 번째 행은 0x00, 그 다음 0x01, ... 40개중 16개까지만 우리가 쓰는데 0x00부터 0x0f까지. 두 번째 줄은 0x40부터 0x4f까지. 이렇게 주소가 맵핑되어있다. 그래서 첫 번째 줄의 첫 번째 칸의 DDRAM 주소는 0x00이 된다. 0x00 DDRAM 주소를 쓰면 이 위치에 출력된다. 이 DDRAM 주소를 어떻게 설정하냐면, 명령어 레지스터로 설정한다. Set DD RAM address 명령어로 설정하고 Data write to CG RAM or DD RAM 로 데이터를 주면 특정 위치에 데이터를 쓸 수 있다.
- 문자발생램(CGRAM) (사용X)
- 문자발생롬(CGROM) (사용X)
- 데이터표시램(DDRAM) 사용한다!

### Text LCD 제어 신호 동작 타이밍

실제적으로 프로세서가 프로그램으로 마이크로프로세서에서 LCD로 신호를 내보내는게 RS, R/W, E, DB7:0 .. 이는 GPIO 특정 핀에 GPIO로 매핑되어있다. 그래서 GPIO 컨트롤러를 이용해서 우리가 원하는 값을 LCD에 내보낼 수 있다. GPIO 핀 번호는 우리가 할당하기 나름... GPIOA, GPIOB, .. 등으로 신호를 만들어내 LCD를 제어할 수 있다. 이 때 타이밍이 어떻게 되나.

명령어 데이터 타입 IR, 데이터에 쓰는 데이터 타입 DR 이 있는데 IR은 RS=0, R/W=0. DR은 RS=1, R/W=0. 그 다음에 LCD에 신호를 내보내는 용도로 하기 위해 항상 E의 값을 1로 내보내주어야 한다. 어떤 데이터가 나가던 간에 E는 항상 1. 

마이크로프로세서와 LCD컨트롤러 사이 연결된 신호에는 RS, R/W, E, DB0~DB7 이 있는데, 값을 쓰려면 E는 1, R/W는 0, IR에 쓰려면 RS=0, DR에 쓰려면 RS=1, 그 다음에 DB0~DB7 에 데이터를 실어주면 이 순간부터 이 순간가지 중에 LCD가 이 신호를 가져가 LCD가 이 신호들을 인식해 원하는 동작을 하도록 한다. 

읽어올 때는 다 똑같은데 R/W만 1로 하면 된다. 이 경우  LCD가 신호를 DB0~DB7에 실어준다.

### Text LCD 제어 명령

0x00 ~ 0x0f

0x40 ~ 0x4f

어떤 명령어들을 내보내는지를 더 구체적으로 살펴보자면, (표)

- CLEAR DISPLAY - RS=0, R/W=0, DB7~DB1=0, DB0=1
- Return Home - DD RAM의 내용 변경하지 않고 커서만을 Home 위치로 이동
- Entry Mode SET - 데이터를 Read 하거나 Write할 때 커서의 위치 증가시키는 것(ID=1)인가 감소시킬 것인가(ID=0)를 설정할 수 있다 이 때 화면을 이동할것인지(S=1) 아닌지(S=0) 결정.
- Display ON/OFF Control - D(화면표시 온오프), C(커서 온오프), B(커서 깜박이는지 아닌지)
- Cursor or Display Shift - 화면을 (S/C=1) 또는 커서를(S/C=0) 오른쪽(R/L=1) 또는 왼쪽(R/L=0)으로 이동시키는지
- Function SET - 데이터 길이를 8비트(DL=1)로 하는지 4비트(DL=0)로 하는지 (우리는 8비트로 사용함.) 그리고 두 행을 다 쓰는지(N=1) 한 행만 쓰는지(N=0) 또 문자의 폰트를 5x10 도트(F=1) 또는 5x7 도트 (F=0)으로 지정하는지

 → 이렇게 여섯 가지는 LCD에 대한 설정이 된다. LCD에 대해 어떤 상태로 하도록 만들거냐.

설정을 했으면 여기에 우리가 원하는 문장이나 단어를 출력시키기 위해서 아래 씀.

- Set CG RAM Address - 사용X
- Set DD RAM Address - DD RAM 설정 (우리가 원하는 DD RAM address 넣어줌. 0100_0000(0x40) ~ 0100_1111(ox4f))
- Read Busy Flag & Address - LCD 장치가 바쁜지 체크. DB7에 해당하는 값이 BF. 1이면 바쁨. 0이면 다음 명령어 실행 가능.
- Data write to CG RAM or DD RAM - 설정된 DD RAM에 어떤 데이터를 씀 (아스키 코드 값?)
- Data read from CG RAM of DD RAM

총 32개 범위 안에서 LCD 사용.

그리고 ASCII 도형문자 종류 및 코드 값...  'A'는 97...

원하는 캐릭터를 쓰면 아스키 코드 값으로 전환되어 저장됨(?) 대문자 알파벳, 소문자 알파벳, 느낌표 등... 사용 가능.

여기까지 간단히 이론적으로 마이크로프로세서 외부 컨트롤러를 제어하는 방법을 알아보기 위해 LCD 제어장치와 그 동작 방식에 대해 살펴보았다.

# 실습: TEXT LCD에 글자쓰기