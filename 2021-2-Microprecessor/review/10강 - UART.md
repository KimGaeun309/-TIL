# 10강 - UART

UART는 보드 외부 장치와 (간단한 소자가 아니라 통신 선으로 연결되는 시스템과) 데이터를 주고받는 가장 기본적인 프로토콜이다.

## UART

기본적으로 UART에 대한 개념을 설명하고, cortex m3칩에서 이 컨트롤러가 어떻게 구현이 되어 있으며 그 컨트롤러를 어떻게 사용하는지. USART와 UART를 통칭해 UART라고 하고, USART도 UART와 동일한 의미로 쓰인다. 그리고 두 가지 실습 - 하나나 마찬가지 - 이 있는데, 실습의 내용이 이번엔 좀 적다(?)

## UART와 RS232 개요

통신(communication)이라고 하는 것은 컴퓨터 네트워크, 전화 등도 통신 시스템이라고 할 수 있는데 가장 기본적인 통신은 사람들 간의 대화도 통신 수단이라 할 수 있다. 기본적으로 통신이라고 하는 것은 두 대상 간의 데이터를 주고 받는 것을 의미한다. 데이터를 주는 쪽이 있으면 받는 쪽도 있다. 통신이 원활히 진행되려면 한 쪽이 데이터를 주면 다른 쪽이 데이터를 받을 수 있도록 정해진 규칙이 필요하다. 예를 들어 사람들 간의 대화에서는 한국어, 영어 등과 같은 언어에 대한 이해가 있어야 한다. 이 규칙을 정하고 규칙에 맞게 데이터를 주고바는데 통신 시스템에서는 이 규칙을 프로토콜(=protocol)이라고 한다. 이 프로토콜을 이해해야 원활하게 소통할 수 있다. 여러가지 프로토콜 규약이 표준으로 정해져 있는데 이 표준에 맞게 구현하면 그 통신을 사용할 수 있다. 우리가 가장 대표적으로 사용하는 통신이 네트워크 통신이다. 네트워크(network)는 IP라던지 eternet이라던지 wifi와 같은 통신을 쓰는데 이 네트워크 통신은 진보된 통신이다. 네트워크는 컴퓨터와 컴퓨터 사이의 통신. 전화, 4G, 5G 등도 네트워크. 컴퓨터와 컴퓨터 사이의 통신 or 컴퓨터와 다른 io 장치 간의 통신. 예를 들어 외부 그래픽 카드 인식..... 

### UART

PC 보드용 io 장치와 연결시키는 통신 컨트롤러 중 가장 간단한 것이 UART이다. UART는 다른 말로 serial 통신이라고도 한다. Universal Asychronos Reciver/Transmitter. 예전에는 시리얼 기반이라 두 개의 선이 있었다. Tx와 Rx. 하나의 선에 연속적으로 데이터를 실어보내는ㄴ 것. Tx는 Transmission, Rx는 Receive.. 예전엔 9개짜리 포트가 나왔다. RS23이라는 포트가. UART를 하드웨어 RS23에 ... 데이터 전송하는 것이 UART 통신. UART는 간단하게 얘기하면 데이터를 하나의 단일 직렬 비트 스트림으로 변환시켜서 하드웨어적으로 내보내는 동작을 하는 것. 1 byte는 8 bit이다. serial 통신을 위해 한 비트씩 보냄. 타임 시그널을 해서 여덟 비트까지 신호를 보내면 시간이 흘렀다고 함. 그리고 받는 족에서는 각 시간마다 주파수의 샘플링을 해서 한 비트씩 받아서 자기 버퍼에 쌓아두어 여덟 비트를 받는다. 나중에 뒤에서 패리티 비트, 시작 비트(먼저 보냄) 그 다음 여덟 비트 보내고 정지 비트 보냄. 종합적으로 UART 통신을 하기 위한 통신 프로토콜을 이해하고 그 프로토콜에 맞도록 컨트롤러의 영역을 제어하면 UART에 연결된 다른 쪽 시스템에 데이터를 전송해줄 수 있다. 

### RS-232C

UART라고 하는 것은 전체적인 프로토콜을 말하는 것이고, RS-232C는 하드웨어 전송 규격이다. 하드웨어 시그널을 어떻게 싣는지에 대한 규약. RS-232는 두 개의 핀이 나간다. Rx와 Tx. 한 쪽이 Rx면 반대쪽에선 Tx, Tx면 반대쪽에선 Rx. 이런 식으로 하드웨어를 연결시켜서 데이터를 어떻게 실을 것인가 하는 신호를 보내는 하드웨어 장치를 RS-232C, Serial 라고 한다. 예전엔 PC에서 항상 RS-232C포트, 구멍 9개에 사다리꼴 모양(?), 하지만 요즘은 이걸 잘 안쓰고 거의 다 USB로 대체됨. USB도 Tx, Rx. (Universal Serial). 이 USB는 UART보다 훨씬 고속의 전송이 가능하도록 프로토콜이 설계된 방식이다. 요즘은 저사향 시스템에서 여전히 UART를 사용하고 있다. PC는 이 포트가 없으니까 Serial to USB Converter를 사용한다. → UART는 아직 사용할 수 있다(?) 

그래서 RS-232C를 사용하기 위해 전송 규약, 프로토콜을 이해할 필요가 있다. 받는 쪽에서 얼마의 속도로 데이터를 전송하는지 알아야 해당 속도에 맞게 비트를 끊어서 받을 수 있다. 이를 통신 속도라고 하는데, UART에서는 이걸 baud rate 라고 하며, 이는 1초당 전송되는 변조된 신호의 수 = frequency 이다. 

### RS-232C를 이용한 비동기식 전송시 규약

그리고 데이터를 보낼 때 신호가 항상 연결되어 이씩에 데이터를 안보낼 땐 데이터 신호가 안가는데 이를 스톱 신호라고 한다. 스톱신호로 쭉 가다가 다시 시작하려면 시작 신호를 내보냄. 이를 Start bit라고 함. 그리고 데이터가 한 번에 한 바이트 내외를 보낼 수 있다. 그래서 한 바이트 신호가 다 갔다는 끝 신호 = Stop bit 를 내보낸다. Start, Stop bit를 뭘로 쓸지 정해주어야 한다. 그리고 또 하나로는 Start bit는 무조건  1 bit를 쓰는데, Stop bit는 0.5, 1, 1.5, 2 비트 중 선택해서 받는 쪽에서 여유를 가질 수 있도록 할 수 있다.

그리고 패리티라고 하는 것은 우리가 항상 통신을 하다 보면 듣는 쪽에서 다르게 들을 수 있는데 컴퓨터 통신에서도 데이터는 디지털로 보내더라도 갈 때는 아날로그로 가기 때문에 받는 쪽에서 노이즈가 발생할 수 있어 데이터가 제대로 보내졌는지 보장이 안됨. 그래서 데이터를 보내는 쪽에서 데이터를 보낼 때 받는 쪽에서 이 데이터를 검증할 수 있는 검증 신호를 추가해서 같이 보낸다. 이 검증 신호는 보통 ECC/CRC라고 하는데 통신에서 이를 패리티라고 한다. UART에서도 패리티를 한 비트를 보내는데 홀수 패리티를 쓸지 홀수 패리티를 쓸지 선택 가능. 예를 들어 0의 개수가 몇 개인지, 1의 개수가 몇 개인지 셈. 1의 개수가 홀수개면 한 비트를 1로 쓴다 등과 같은 걸 정해 검증. 그래서 항상 패리티 신호는 데이터와 상관 없는 추가 데이터이다. 이 패리티를 가지고 받는 쪽에서 간단하게 데이터를 잘 받았는지 아닌지 검증 가능. 하지만 만약 한 비트만 오류가 난 것이 아니라, 두 비트가 오류가 나면 짝수가 유지되기에 오류가 나지 않았다고 오인식을 할 수 있음. 그래서 이 패리티비트를 늘이면 늘일수록 오류 검증이 더 확실해진다. 그래서 보통 통신에서 패리티 데이터를 더 많이 붙여 보내는 경우도 많다.

자료 길이는 일반적으로 8비트이나 9비트로 설정할 수도 있다. 하지만 일반적으로는 8비트를 사용한다. 우리가 쉽게 설정할 수 있는 값이기 때문에.

이런 것들을 어떻게 설정해주고 어떻게 데이털르 내보내는지를 이해하면 UART 컨트롤러를 사옹해 데이터 송수신을 할 수 있을 것이다. 간단하게 UART 컨트롤러에 대해 

## STM32F103의 직렬통신 포트

UART 프로토콜을 설정하거나 동작시키기 위해 우리가 사용하는 Cortex-M3의 UART 컨트롤러가 어떻게 만들어졌는지를 이해해보자.

### STM32F103의 직렬통신 포트

직렬통신포트 USART가 3개 혹은 4개까지 들어있고 우리는 그 중 하나를쓴다.

기능은 완전 이중방식으로 데이터의 송신과 수신이 모두 가능한 방식으로 되어있다.

그리고 synchronous 동기, asynchronous 비동기 전달이 가능하다.  

또 높은 정밀도의 보레이트 발생기를 내장한다. 9600(6900?) ~ 115200 보레이트 사용 가능. 최대 초당 수 kb 전송 가능. 요즘엔 느림. 

그리고 데이터를 받을 때 인터럽트 시그널을 발생시킬 수 있다. 그래서 인터럽트 서비스를 사용할 수 있지만 우리 실습에서는 UART를 인터럽트 형식으로 사용하지 않고 Polling 방식의 데이터 송수신 기능을 사용할 것이다.

### STM32F103 USART 데이터 프레임 포맷

1. 보레이트 설정 필요
2. 스타트 비트 설정 필요
3. 패리티 설정 필요
4. 데이터 크기 설정 필요
5. 스탑 비트 설정 필요 

스타트 비트는 항상 한 비트를 설정하도록 되어있고 항상 0으로 설정을 한다. 데이터비트는 8비트, 9비트 중 정할 수 있는데 우리는 8비트 사용할 것. 

스탑비트가 나가다가(1 이 나감.) 스타트 비트부터 0으로 나간다. 그 다음에 UART 컨트롤러 안의 데이터 레지스터에 데이터를 쓰면 (예를 들어 'A'면 0x97 = 10010111) 한 비트씩 클럭이 동기화되어서 데이터가 실린다.  그 다음에 패리티 설정을 해두었다면 패리티 비트가 마지막에 한 비트 실린다. 그 다음에 스탑 비트가 나간다. (스탑 비트는 무조건 1) 이 스탑 비트의 신호의 길이는 네 가지 경우 중 하나로 설정 가능하다. (0.5, 1, 1.5, 2) 

이것이 하나의 데이터 Frame이 되어 받는 쪽에서 샘플링해서 데이터를 받는다. 

### STM32F103 USART 레지스터

어떤 비트를 설정? 전송할 데이터를 어디에 씀? 데이터 전송이 완료되면 어떻게 인식? 데이터가 수신된 건 어떻게 인식?

- USART_SR(Status Register)

상태 레지스터. 데이터 전송이 이루어졌는지(송신이 완료되었는지), 수신된 데이터가 있는지 상태 확인. 

TXE, TC, (→ 데이터를 쓰면 한 비트씩 빠져나가고 전송이 완료되면 Empty가 된다. 이렇게 되면  TC가 1이 된다. TXE와 TC를 보고 데이터 전송이 완료되었는지를 확인할 수 있다.)  

RXNE (비지 않았다. Rx를 통해 송신된 데이터가 DR에 채워지면 RXNE가 1이 된다. 이 비트를 관찰하고 있다가 이 비트가 1이 되면 송신된 데이터가 있음을 확인하고 DR의 데이터를 읽어오면 된다.)

FE, PE (→ frame error나 parity error, 데이터를 제대로 받지 못했거나 데이터를 받았으나 패리티 값이 다르면 set(?))

- USART_DR(Data Register)

보낼 데이터가 있으면 그 값을 여기에 써서 밖으로 내보내고, 받을 때도 이 레지스터에 데이터를 받음. (상태 레지스터의 특정비트를 관찰하다가 1이 들어오면 DR 레지스터에 수신받은 데이터가 있음을 알고 DR을 읽어가면 된다.)

데이터를 송신할 때 송신할 데이터를 여기에 쓰고 송신하라고 하는 비트를 1로 설정하면 Tx로 이 데이터가 나감. 우리는 0~7을 사용해 데이터를 내보낼 것.

- USART_BRR(Baud Rate Register)

송수신할 때 속도를 설정해주기 위한 레지스터. 보우레이트 레지스터.

kbps를 보우레이트로 씀. 9600 보우레이트 = 9600kbps. 이 보우레이트를 보우레이틀 레지스터의 하위 16개 비트로 설정. 이 때 보우레이트는 소수로 되어 있기 때문에 보통 fixed point 표현법을 사용한다. 소수점 이상의 값과 이하의 값을 분리시켜서 특정 영역에 할당(?)시키는 것. 소수점에 들어가는 값을 정수로 표현시키기 위해 소수점 아래 값에 16을 곱해서 저장하게끔 되어 있다. 

이론적으로는 clock frequency가 있다. 우리가 타이머에서도 했듯이 보우레이트를 설정하기 위해 기본적으로 공식에 들어가는 게 두 가지가 있다 - 36MHz, 72MHz. 36MHz 기준으로 어떻게 계산이 되냐면, 보우레이트 =  frequency / 16 * BRR 레지스터 값 이고, BRR = frequency / 16 * 보우레이트

9600 보우레이트 → BRR = 36 * 20^6 / 16 * 9600 = 234.375.

이 공식은 외워야 한다. 하드웨어적으로 정해져 있기 때문에.

소수점 이상 234 는 BRR의 상위 12비트에  → 11101010

소수점 이하 375는 하위 4비트에. → 0.375 * 16 = 6 → 0110

→ 111010100110

- USART_CR1(Control Register)

컨트롤 레지스터는 스타트비트, 스톱비트, 패리티, 데이터비트의 크기 등을 설정할 때 쓴다.

M - word length (data length) - 8 or 9. (0 이면 8비트, 1이면 9비트)

PCE - parity bit enable or not (0 이면 disable, 1이면 enable)

PS - odd parity? even parity?

UE - uart enable

TE - transmission enable (다른 설정을 다 하고 DR레지스터에 전송할 데이터를 쓰고 TE를 1로 설정하고 UE를  1로 설정하면 DR의 데이터가 자동으로 나가고 데이터가 다 나가면 SR의 TC가 1로 바뀐다. )

RE - receive enable. (데이터 받을 수 있게 설정. 데이터가 왔다는 것은 SR의 RXNE 비트 Polling하다가 1이 되면 DR의 데이털르 읽어감.)

인터럽트 관련된 비트들 있음.

- USART_CR2(Control Register)

스탑비트 설정.

- 챕터 25 USART 관련 설명.아까 얘기했던 여러가지 기능에 대한 설명이 있음.

# 실습 1 : UART로 Hello 보내기

# 실습 2 : UART로 PC와 데이터 주고받기